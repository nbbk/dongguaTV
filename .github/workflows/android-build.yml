name: Android Build & Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. ç¯å¢ƒå‡†å¤‡
      - name: Setup Node.js (v22)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Java (v21)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Dependencies
        run: npm install

      # 2. å‡†å¤‡ç½‘é¡µèµ„æº
      - name: Fix Web Assets
        run: |
          mkdir -p www
          if [ -d "public" ]; then
            cp -r public/* www/
          else
            echo "<h1>App</h1>" > www/index.html
          fi

      # 3. ç”Ÿæˆå›¾æ ‡
      - name: Generate App Icons
        run: |
          echo "ğŸ¨ Starting Icon Generation..."
          sudo apt-get update && sudo apt-get install -y imagemagick
          if [ -f "public/icon.png" ]; then
            RES_PATH="android/app/src/main/res"
            mkdir -p $RES_PATH/mipmap-mdpi $RES_PATH/mipmap-hdpi $RES_PATH/mipmap-xhdpi $RES_PATH/mipmap-xxhdpi $RES_PATH/mipmap-xxxhdpi
            generate_icon() {
              convert "public/icon.png" -resize ${1}x${1} $RES_PATH/$2/ic_launcher.png
              convert "public/icon.png" -resize ${1}x${1} $RES_PATH/$2/ic_launcher_round.png
              convert "public/icon.png" -resize ${1}x${1} $RES_PATH/$2/ic_launcher_foreground.png
            }
            generate_icon 48 "mipmap-mdpi"
            generate_icon 72 "mipmap-hdpi"
            generate_icon 96 "mipmap-xhdpi"
            generate_icon 144 "mipmap-xxhdpi"
            generate_icon 192 "mipmap-xxxhdpi"
            echo "âœ… Icons generated!"
          else
            echo "âš ï¸ No public/icon.png found!"
          fi

      # 4. åŒæ­¥ Capacitor
      - name: Sync Capacitor
        run: npx cap sync android

      # 5. â˜…â˜…â˜… ç»æ€æ”¹åï¼šManifest + Strings â˜…â˜…â˜…
      - name: Force Rename App (Nuclear Option)
        run: |
          # è·å–æ–°åå­—
          NEW_NAME=$(jq -r '.appName' capacitor.config.json)
          echo "ğŸ”¥ Target Name: $NEW_NAME"

          MANIFEST="android/app/src/main/AndroidManifest.xml"
          sed -i "s/android:label=\"[^\"]*\"/android:label=\"$NEW_NAME\"/g" $MANIFEST
          echo "âœ… Manifest updated:"
          grep "android:label" $MANIFEST

          # ã€æ“ä½œBã€‘åœ°æ¯¯å¼æ›¿æ¢æ‰€æœ‰ strings.xml (åŒ…æ‹¬ values-zh, values-en ç­‰)
          echo "ğŸ” Searching for strings.xml files..."
          find android/app/src/main/res -name "strings.xml" | while read file; do
             echo "   -> Updating $file"
             # å¼ºåˆ¶æ›¿æ¢ <string name="app_name">...</string> è¿™ä¸€æ•´è¡Œ
             sed -i "s|<string name=\"app_name\">.*</string>|<string name=\"app_name\">$NEW_NAME</string>|g" "$file"
          done

      # 6. æ„å»º APK
      - name: Build Debug APK
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug

      # 7. ä¸Šä¼ 
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: APP-APP
          path: android/app/build/outputs/apk/debug/*.apk
